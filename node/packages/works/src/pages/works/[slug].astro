---
import codeStyle from "highlight.js/styles/base16/snazzy.min.css?url";
import bbStyle from "baguettebox.js/dist/baguetteBox.min.css?url";

import { WorkPage } from "../../components/pages/works.[slug]";

import HTML from "../../layouts/html.astro";
import { ArticleLayout } from "../../layouts/articleLayout";
import { parseMd2Html } from "../../components/pages/parseMd2Html";
import { getWorks } from "../../api/notion/works";
import { getMarkdownBody } from "../../api/notion/markdownBody";
import { useEnv } from "../../utils/env";
import { Head } from "../../components/parts/head";

const { OG_IMAGE_SERVER_URL } = useEnv();

export async function getStaticPaths() {
  const works = await getWorks();
  return works
    .filter((work) => work.slug !== "")
    .map((work) => {
      return { params: { slug: work.slug } };
    });
}

const { slug } = Astro.params;

const work = (await getWorks({ slug }))[0];
const bodyMd = await getMarkdownBody(work.id);
const body = await parseMd2Html(bodyMd);
---

<HTML>
  <Fragment slot="head">
    <Head
      url={`/works/${slug}`}
      title={`${work.title} - ichi-h.com`}
      description={work.description}
      ogType="article"
      ogImage={`${OG_IMAGE_SERVER_URL}?title=${work.title}`}
    />
    <link rel="stylesheet" href={codeStyle} />
    <link rel="stylesheet" href={bbStyle} />
  </Fragment>
  <Fragment slot="content">
    <ArticleLayout title={work.title}>
      <WorkPage work={work} body={body} />
    </ArticleLayout>
  </Fragment>
</HTML>

<script>
  import hljs from "highlight.js";
  import mermaid from "mermaid";

  hljs.highlightAll();
  mermaid.initialize({ startOnLoad: true });

  if (document.getElementById('gallery')) {
    import('baguettebox.js').then(({ default: baguetteBox }) => {
      baguetteBox.run('#gallery', {
        filter: /.*/,
        overlayBackgroundColor: 'rgba(0, 0, 0, 0.9)',
      });
    });
  }
</script>
