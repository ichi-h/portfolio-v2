# 技術・開発系アプリケーション追加 実装タスクリスト

## 概要

- `works`で表示している技術・開発系のコンテンツを分離し、別ページとして新しく立ち上げる
- 技術スタックは`works`とほぼ同じにし、アーキテクチャも変更せず、モノレポ内の既存リソースを再利用
- Notionの共通DBを使用し、「development」カテゴリで技術系コンテンツを絞り込む
- パフォーマンス最適化はひとまず画像とWebフォントのみに焦点を当てる

## プロジェクト構成

```
node/packages/
├── shared/          # 新規: プロジェクト共通リソース
│   └── src/
│       ├── features/    # ドメインごとに分離したリソース
│       │   └── notion/  # Notion API関連
│       └── utils/       # ドメインに依存しない共通ユーティリティ
├── tech/            # 新規: 技術系コンテンツアプリケーション
└── works/           # 既存: ポートフォリオページ
```

---

## フェーズ1: 共通パッケージの作成

### タスク1-1: `shared`パッケージの基本構造作成

**ディレクトリ構造:**

```
node/packages/shared/
├── package.json
├── tsconfig.json
├── vite.config.ts
└── src/
    ├── index.ts
    ├── features/
    │   └── notion/
    │       └── index.ts
    └── utils/
        └── index.ts
```

**実装内容:**

- `package.json`を作成
  - `name`: `"portfolio-shared"`
  - `type`: `"module"`
  - dependencies: TypeScriptの基本的な依存関係のみ
- `tsconfig.json`を作成 (`works`の設定を参考)
- `vite.config.ts`を作成 (ライブラリモードでビルド)
- エントリーポイント用の`index.ts`ファイルを作成

---

### タスク1-2: Notion API機能を`shared/src/features/notion`へ移行

**移行対象:**

- `works/src/api/notion/works.ts`
- `works/src/api/notion/markdownBody.ts`

**実装内容:**

- `shared/src/features/notion/client.ts`を作成
  - Notion APIクライアントの初期化ロジック
- `shared/src/features/notion/database.ts`を作成
  - データベース取得の汎用ロジック
  - カテゴリフィルタリング機能 (例: `category: "development"`)
- `shared/src/features/notion/markdown.ts`を作成
  - NotionコンテンツをMarkdownに変換するロジック
- `shared/src/features/notion/types.ts`を作成
  - Notion関連の型定義
- `shared/src/features/notion/index.ts`を作成
  - 上記モジュールをエクスポート

**依存関係:**

```json
{
  "dependencies": {
    "@notionhq/client": "^2.2.14",
    "notion-to-md": "^3.1.1"
  }
}
```

---

### タスク1-3: 共通ユーティリティを`shared/src/utils`へ移行

**移行候補:**

- `works/src/utils/env.ts` - 環境変数管理
- `works/src/utils/result.ts` - Result型パターン
- `works/src/utils/date.ts` - 日付処理
- `works/src/utils/queryParams.ts` - クエリパラメータ処理

**実装内容:**

- 上記ファイルを`shared/src/utils/`へコピー
- `shared/src/utils/index.ts`でエクスポート
- 必要に応じてドメイン固有のロジックを除去し、汎用化

---

### タスク1-4: `shared`パッケージのビルド設定

**実装内容:**

- `vite.config.ts`でライブラリモードの設定
  - エントリーポイント: `src/index.ts`
  - 出力形式: ES module と UMD
  - 型定義ファイルの生成設定
- `package.json`の`exports`フィールドを設定
  ```json
  {
    "exports": {
      ".": {
        "import": "./dist/portfolio-shared.es.js",
        "require": "./dist/portfolio-shared.umd.js",
        "types": "./dist/index.d.ts"
      },
      "./notion": {
        "import": "./dist/features/notion/index.js",
        "types": "./dist/features/notion/index.d.ts"
      },
      "./utils": {
        "import": "./dist/utils/index.js",
        "types": "./dist/utils/index.d.ts"
      }
    }
  }
  ```

---

## フェーズ2: `works`パッケージのリファクタリング

### タスク2-1: `works`で`shared`パッケージを使用

**実装内容:**

- `works/package.json`に依存関係を追加
  ```json
  {
    "dependencies": {
      "portfolio-shared": "workspace:*"
    }
  }
  ```
- `works/src/api/notion/works.ts`を更新
  - `shared/features/notion`からNotionクライアント、データベース取得ロジックをimport
  - カテゴリフィルタリングを適用 (例: `category !== "development"`)
- `works/src/utils/`配下のファイルを`shared/utils`からimportするよう変更
- 元の`works/src/api/notion/`と`works/src/utils/`から移行済みファイルを削除または更新

---

## フェーズ3: `tech`パッケージの作成

### タスク3-1: `tech`パッケージの基本構造作成

**ディレクトリ構造:**

```
node/packages/tech/
├── package.json
├── tsconfig.json
├── astro.config.mjs
├── .gitignore
├── README.md
├── .env
├── public/
│   ├── favicon.ico
│   ├── bg-optimized.webp    # 軽量化された背景画像
│   └── ogp-optimized.jpg    # 軽量化されたOGP画像
└── src/
    ├── api/
    ├── assets/
    ├── components/
    │   ├── pages/
    │   └── parts/
    ├── layouts/
    ├── pages/
    └── utils/
```

**実装内容:**

- `package.json`を作成 (`works`をベースに)
  ```json
  {
    "name": "tech",
    "type": "module",
    "version": "0.0.1",
    "scripts": {
      "dev": "astro dev",
      "build": "astro build",
      "preview": "astro preview",
      "deploy": "wrangler pages deploy dist/ --project-name portfolio-tech"
    },
    "dependencies": {
      "@astrojs/react": "^4.2.3",
      "astro": "^5.6.1",
      "portfolio-shared": "workspace:*",
      "portfolio-styles": "workspace:*",
      "portfolio-ui": "workspace:*",
      "rehype-slug": "^6.0.0",
      "rehype-stringify": "^10.0.1",
      "remark-parse": "^11.0.0",
      "remark-rehype": "^11.1.2",
      "unified": "^11.0.5"
    }
  }
  ```
- `tsconfig.json`を作成 (`works`と同様の設定)
- `astro.config.mjs`を作成 (`works`と同様、vanilla-extractプラグインを含む)
- `.gitignore`を作成
- `README.md`を作成 (アプリケーションの概要を記載)

---

### タスク3-2: Notion API統合

**実装内容:**

- `tech/src/api/notion/tech.ts`を作成
  - `shared/features/notion`から必要な関数をimport
  - `category: "development"`でフィルタリング
  - `getTechPosts()`関数を実装
- `.env`ファイルに環境変数を設定
  ```
  NOTION_API_KEY=your_notion_api_key
  NOTION_DATABASE_ID=your_database_id
  APP_URL=http://localhost:4321
  ```

**実装例:**

```typescript
import { getDatabase, filterByCategory } from "portfolio-shared/notion";

export const getTechPosts = async () => {
  const allPosts = await getDatabase(process.env.NOTION_DATABASE_ID);
  return filterByCategory(allPosts, "development");
};
```

---

### タスク3-3: ページとレイアウトの作成

**実装内容:**

**3-3-1: ベースレイアウト (`src/layouts/html.astro`)**

- `works/src/layouts/html.astro`をベースに作成
- システムフォントスタックを使用 (Webフォントは削除)
  ```css
  font-family:
    -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans JP",
    "Hiragino Sans", sans-serif;
  ```

**3-3-2: トップページ (`src/pages/index.astro`)**

- `works/src/pages/index.astro`をベースに作成
- 技術系コンテンツのリスト表示
- `getTechPosts()`を使用してコンテンツを取得

**3-3-3: 個別記事ページ (`src/pages/[slug].astro`)**

- `works/src/pages/works/[slug].astro`をベースに作成
- 動的ルーティングで個別記事を表示

**3-3-4: カテゴリページ (オプション)**

- 必要に応じて`src/pages/categories/`を作成

---

### タスク3-4: コンポーネントの作成

**実装内容:**

**3-4-1: 背景コンポーネント (`src/components/parts/background.tsx`)**

- `works/src/components/parts/background.tsx`をベースに作成
- 軽量化された背景画像を参照
  ```tsx
  <Bg
    src="/bg-optimized.webp"
    opacity={80}
    layoutPosition="fixed"
  >
  ```

**3-4-2: ヘッダー/ナビゲーション (`src/components/parts/nav.tsx`)**

- `portfolio-ui`のコンポーネントを使用
- `works`と`tech`間のナビゲーションリンクを追加

**3-4-3: その他の共有コンポーネント**

- `works`から必要なコンポーネントをコピー
  - `footer.tsx`
  - `head.tsx`
  - `linkCard.tsx`
  - など
- `portfolio-ui`パッケージのコンポーネントを最大限活用

---

### タスク3-5: スタイリング

**実装内容:**

- `portfolio-styles`パッケージのスタイルを使用
- コンポーネント固有のスタイルは`.css.ts`ファイルで定義
- システムフォントスタックをグローバルスタイルで設定
- 画像最適化設定
  - 遅延読み込み (loading="lazy")
  - 適切なサイズ指定

---

## フェーズ4: ビルドとデプロイ設定

### タスク4-1: Turborepビルド設定の更新

**実装内容:**

- `node/turbo.json`を更新
  ```json
  {
    "pipeline": {
      "build": {
        "dependsOn": ["^build"],
        "outputs": ["dist/**"]
      }
    }
  }
  ```
- `shared`と`tech`パッケージのビルド依存関係を定義

---

### タスク4-2: pnpm workspace設定の確認

**実装内容:**

- `node/pnpm-workspace.yaml`が新しいパッケージを含んでいることを確認
  ```yaml
  packages:
    - "packages/*"
  ```

---

### タスク4-3: Cloudflare Pages デプロイ設定

**実装内容:**

- Cloudflare Dashboardで新しいプロジェクト`portfolio-tech`を作成
- 環境変数を設定
  - `NOTION_API_KEY`
  - `NOTION_DATABASE_ID`
  - `APP_URL`
- `tech/package.json`のdeployスクリプトを確認
- `.github/workflows/deploy-portfolio.yml`を更新して`tech`のデプロイを追加

---

## フェーズ5: 動作確認とテスト

### タスク5-1: ローカル開発環境での動作確認

**実施内容:**

- `shared`パッケージのビルド
  ```bash
  cd node/packages/shared
  pnpm build
  ```
- `tech`アプリケーションの起動
  ```bash
  cd node/packages/tech
  pnpm dev
  ```
- 以下を確認
  - Notionからのデータ取得 (developmentカテゴリのみ)
  - ページレンダリング
  - 画像の表示 (軽量化された画像)
  - システムフォントの適用

---

### タスク5-2: `works`アプリケーションの動作確認

**実施内容:**

- `works`アプリケーションの起動
  ```bash
  cd node/packages/works
  pnpm dev
  ```
- 以下を確認
  - `shared`パッケージからの正しいimport
  - developmentカテゴリ以外のコンテンツが表示される
  - 既存機能が正常に動作

---

### タスク5-3: ビルドの確認

**実施内容:**

- モノレポ全体のビルド
  ```bash
  cd node
  pnpm build
  ```
- ビルドが成功することを確認
- `tech/dist/`が正しく生成されることを確認

---

## フェーズ6: ドキュメント作成

### タスク6-1: `tech`パッケージのREADME作成

**実装内容:**

- `tech/README.md`を作成
  - アプリケーションの概要
  - 開発方法
  - ビルド方法
  - デプロイ方法
  - `works`との違い

---

### タスク6-2: `shared`パッケージのREADME作成

**実装内容:**

- `shared/README.md`を作成
  - パッケージの目的
  - 提供している機能
  - 使用方法
  - 各feature/utilsの説明

---

## チェックリスト

### Phase 1: 共通パッケージ

- [ ] `shared`パッケージの基本構造作成
- [ ] Notion API機能を`shared/src/features/notion`へ移行
- [ ] 共通ユーティリティを`shared/src/utils`へ移行
- [ ] `shared`パッケージのビルド設定

### Phase 2: worksリファクタリング

- [ ] `works`で`shared`パッケージを使用

### Phase 3: techパッケージ

- [ ] `tech`パッケージの基本構造作成
- [ ] Notion API統合 (developmentカテゴリフィルタ)
- [ ] ページとレイアウトの作成
- [ ] コンポーネントの作成
- [ ] スタイリング (システムフォント、画像最適化)

### Phase 4: ビルドとデプロイ

- [ ] Turborepビルド設定の更新
- [ ] pnpm workspace設定の確認
- [ ] Cloudflare Pages デプロイ設定

### Phase 5: テスト

- [ ] ローカル開発環境での動作確認
- [ ] `works`アプリケーションの動作確認
- [ ] ビルドの確認

### Phase 6: ドキュメント

- [ ] `tech`パッケージのREADME作成
- [ ] `shared`パッケージのREADME作成

---

## 重要な注意事項

### パフォーマンス最適化

**画像:**

- 背景画像: 軽量化されたWebPを使用 (`bg-optimized.webp`)
- OGP画像: 軽量化されたJPGを使用 (`ogp-optimized.jpg`)
- 遅延読み込みを適用 (`loading="lazy"`)
- 画像フォーマット変換は手動で実施済み

**Webフォント:**

- Webフォントは使用しない
- システムフォントスタックを使用
- フォント関連のCDNリンクや`@font-face`は削除

### Notion DBフィルタリング

- `works`: `category !== "development"`のコンテンツを表示
- `tech`: `category === "development"`のコンテンツを表示
- フィルタリングロジックは`shared/features/notion`で共通化

### モノレポ構成

- `shared`: プロジェクト共通のロジックとユーティリティ
  - `features/`: ドメインごとに分離 (notion, 将来的に他のドメインも)
  - `utils/`: ドメイン非依存の汎用ユーティリティ
- `tech`: 技術系コンテンツ専用アプリケーション
- `works`: ポートフォリオページ (既存、`shared`を使用するようリファクタリング)
